<div ng-include="'views/navigation.html'"></div>

<div ng-controller="sessionCtrl" ng-style="{height: activeSession.viewport.height, width: activeSession.viewport.width}"
	   class="group-container">
	<div class="controls" 
			 ng-class="{'dock-left': dock.position == 'left', 
									'dock-right': dock.position == 'right',
									'fixed': dock.pinned,
									'hidden-left': dock.hidden && dock.position == 'left',
									'hidden-right': dock.hidden && dock.position == 'right'}">
		<ul class="nav nav-list shot-list">
			<li class="nav-header">Screen Shots ({{activeSession.shots.length}})</li>
			<li ng-click="setCurrentTab(shot)" 
					 ng-repeat="shot in activeSession.shots"
					 ng-class="{active: activeSession.currentTab == shot.id}">
					 <a>
							<span class="fa" ng-click="shot.show = !shot.show" 
								 ng-class="{'fa-eye': shot.show, 'fa-eye-slash': !shot.show}"></span>
							<div class="url-display">{{shot.displayURL}}</div>
							<span class="fa fa-trash-o" ng-click="removeShot(shot)"></span>
							<span class="fa font-red fa-youtube-play" ng-show="shot.screenAnimate || shot.differenceAnimate"></span>
					 </a>
			 </li>
		 </ul>
		<ul class="nav nav-list shot-list">
			<li class="nav-header">Differences ({{activeSession.differences.length}})</li>
			<li ng-click="setCurrentTab(shot)" 
					ng-repeat="shot in activeSession.differences"
					ng-class="{active: activeSession.currentTab == shot.id}">
				<a>
					<span class="fa" ng-click="shot.show = !shot.show" 
						 ng-class="{'fa-eye': shot.show, 'fa-eye-slash': !shot.show}"></span>
					<div class="url-display">Difference {{$index + 1}}</div>
					<span class="fa fa-trash-o" ng-click="removeGeneratedDifference()"></span>
					<span class="fa font-red fa-youtube-play" ng-show="shot.screenAnimate || shot.differenceAnimate"></span>
				</a>
			</li>
		</ul>
		<div class="tab-controls">
			<div ng-controller="tabControlsCtrl" 
					ng-include src="'controls.html'">
			</div>
		</div>
		<div class="btn-group position-controls">
			<button class="btn btn-default" type="button" ng-click="dock.position = 'left'">
				<span class="fa fa-arrow-left"></span>
			</button>
			<button class="btn btn-default" type="button" ng-click="dock.position = 'right'">
				<span class="fa fa-arrow-right"></span>
			</button>
			<button class="btn btn-default" ng-click="onScrollTop()">
				<span class="fa fa-long-arrow-up"></span>
			</button>
			<button class="btn btn-default" ng-click="onScrollBottom()">
				<span class="fa fa-long-arrow-down"></span>
			</button>
			<button class="btn btn-default" ng-click="activeSession.viewport.center()">
				<span class="fa fa-align-center"></span>
			</button>
			<button class="btn btn-default" type="button" ng-model="dock.pinned" btn-checkbox>
				<span class="fa fa-thumb-tack"></span>
			</button>
		</div>
		<div class="zoom-indicator input-prepend">
			<span class="add-on fa fa-search"></span>
			<input class="input-mini" readonly type="text" ng-value="activeSession.viewport.zoom.level | percent">
		</div>
		<div class="expand-tab" ng-click="dock.hidden = !dock.hidden">
			<span class="fa" ng-class="{'fa-chevron-left': (dock.position == 'right' && dock.hidden)
									|| (dock.position == 'left' && !dock.hidden),
										'fa-chevron-right': (dock.position == 'left' && dock.hidden)
									|| (dock.position == 'right' && !dock.hidden)}"></span>
		</div>
	</div>
	
	<div ng-repeat="shot in activeSession.shots" 
		ng-style="{left: activeSession.viewport.left + (shot.screenPosition.x * activeSession.viewport.zoom.level), 
		           top: activeSession.viewport.top + 41 + (shot.screenPosition.y * activeSession.viewport.zoom.level)}" class="shot-container" 
			 zoom="activeSession.viewport.zoom.level"
			 ng-class="{'active-tab': activeSession.currentTab == shot.id, 'opacity-hide': !shot.show}">
		<canvas image-canvas class="screen-shot" animate-opacity="shot.screenAnimate" 
				 animate-time="shot.screenAnimateTime" 
				 src="shot.screen.path"
				 ng-style="{opacity: shot.screenOpacity}"></canvas>
	</div>
	<div ng-repeat="shot in activeSession.differences"
			 class="shot-container"
			 ng-style="{left: activeSession.viewport.left + (shot.screenPosition.x * activeSession.viewport.zoom.level), 
		              top: activeSession.viewport.top + 41 + (shot.screenPosition.y * activeSession.viewport.zoom.level)}"
			 zoom="activeSession.viewport.zoom.level"
			 ng-class="{'active-tab': activeSession.currentTab == shot.id, 'opacity-hide': !shot.show}">
		<canvas class="screen-shot" buffer-canvas buffers="shot.buffers" 
						pixel-width="shot.width" pixel-height="shot.height" 
						animate-opacity="shot.screenAnimate" 
						animate-time="shot.screenAnimateTime"
						ng-style="{opacity: shot.screenOpacity}"></canvas>>
		</canvas>
	</div>
</div>

<!-- Difference Modal -->

<div ng-include="'views/differenceModal.html'"></div>

<!-- File Upload modal -->

<div modal="uploader.open" ng-controller="uploaderCtrl"
		 close="uploader.open = false" options="uploader.options">
	<div class="modal-header">
		<h4>Upload Images</h4>
	</div>
	<div class="modal-body">
		<h5>Select image files you want to upload.</h5>
		<table class="table table-condensed table-hover">
			<tr ng-repeat="file in uploadedFiles">
				<td><span class="fa fa-file"></span></td>
				<td>{{file.name}}</td>
			</tr>
		</table>
		<form>
			<input file-upload="onFileSelect($files)" name="files[]" type="file" multiple upload>
		</form>
	</div>
	<div class="modal-footer">
		<a class="btn btn-default" ng-click="uploader.hide()">Cancel</a>
		<a class="btn btn-primary" ng-click="upload()">Upload</a>
	</div>
</div>

<!-- Alerts -->

<div class="alerts fixed" ng-class="{'dock-left': dock.position == 'right'}">
	<alert ng-repeat="alert in alerts" type="alert.type" close="removeAlert(alert._id)">
		<span class="fa-spin fa fa-spinner" ng-show="alert.loading"></span> {{alert.msg}}
		<div ng-show="alert.progress">
			<progress percent="alert.progressPercent" class=""></progress>
		</div>
	</alert>
</div>


<script type="text/ng-template" id="controls.html">
	<div class="control-list">
		<div class="control-section" ng-class="{disabled: !activeSession.currentShot.show}">
			<label>Opacity <span ng-show="activeSession.currentShot">{{activeSession.currentShot.screenOpacity | percent}}</span></label>
			<input slider="onOpacityChange(shot.id, $value)" ng-disabled="!activeSession.currentShot.show || activeSession.currentShot.screenAnimate" 
				type="range" min="0" max="1" step="0.01" ng-value="activeSession.currentShot.screenOpacity" value="1"/>
			<div class="btn-group">
				<button class="btn btn-default btn-mini" type="button" ng-click="activeSession.currentShot.screenAnimate = false" ng-disabled="!activeSession.currentShot.show">
					<span class="fa fa-stop"></span>
				</button>
				<button class="btn btn-default btn-mini" type="button" ng-model="activeSession.currentShot.screenAnimate" 
								ng-change="onScreenAnimate()" btn-checkbox ng-disabled="!activeSession.currentShot.show">
					<span class="fa fa-play"></span>
				</button>
			</div>
			<div class="time-input mini-input input-prepend input-append">
				<span class="add-on">Time:</span>
				<input class="input-mini" ng-model="activeSession.currentShot.screenAnimateTime" type="number">
				<span class="add-on">s</span>
			</div>
		</div>
		
		<div class="control-section position" ng-class="{disabled: !activeSession.currentShot.show}">
			<label>Position</label>
			<div class="mini-input input-prepend">
				<span class="add-on">x</span>
				<input class="input-mini" ng-disabled="!activeSession.currentShot.show" type="number" ng-model="activeSession.currentShot.screenPosition.x">
			</div>
			<div class="mini-input input-prepend">
				<span class="add-on">y</span>
				<input class="input-mini"  ng-disabled="!activeSession.currentShot.show" type="number" ng-model="activeSession.currentShot.screenPosition.y">
			</div>
			<button class="btn btn-default btn-mini" ng-click="resetPosition(activeSession.currentShot.screenPosition)">
				<span class="fa fa-refresh"></span>
			</button>
		</div>

		<div class="control-section" ng-show="shot.type != 'source' && shot.type != 'upload'">
			<label>Info</label>
			<table class="table table-condensed">
				<tr>
					<td>Total Pixels</td>
					<td>{{shot.data.totalPixels | number}}</td>
				</tr>
				<tr>
					<td>Same Pixels</td>
					<td>{{shot.data.numberOfSamePixels | number}}</td>
				</tr>
				<tr>
					<td>Different Pixels</td>
					<td>{{shot.data.numberOfDifferentPixels | number}}</td>
				</tr>
				<tr>
					<td>Difference Ratio</td>
					<td>{{shot.data.differenceRatio | percent}}</td>
				</tr>
			</table>
		</div>
	</div>
</script>

